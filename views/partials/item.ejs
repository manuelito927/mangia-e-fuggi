<%
// Pre-elaborazioni sicure per evitare errori di sintassi dentro gli attributi
const rawName     = String(name || '');
const priceNum    = Number(price || 0);
const priceFixed  = priceNum.toFixed(2);
const priceLabel  = priceFixed.replace('.', ',');
// per l'ID aria e simili
const safeId      = rawName.toLowerCase().replace(/[^a-z0-9]+/gi,'_');
// per passare il nome dentro apici singoli in JS
const safeNameJs  = rawName.replace(/'/g, "\\'");
%>

<div
  class="item"
  data-name="<%= rawName %>"
  data-price="<%= priceFixed %>"
>
  <!-- FOTO -->
  <div class="thumb">
    <img
      src="<%= img || '/img/fallback.jpg' %>"
      alt="<%= rawName %>"
      loading="lazy"
      decoding="async"
      onerror="this.src='/img/fallback.jpg'">
  </div>

  <!-- TESTO -->
  <div class="i-left">
    <!-- Nome prodotto -->
    <div class="i-name" data-i18n-name="<%= rawName %>"><%= rawName %></div>

    <!-- Descrizione + NOTA INLINE PICCOLA TRA PARENTESI -->
    <% if (desc) { %>
      <div class="i-desc" data-i18n-desc="<%= desc %>">
        <em><%= desc %></em>
        <span class="note-wrap" style="font-size:12px;color:#7b6d66;margin-left:6px;white-space:nowrap">
          ( <input
              id="note-<%= safeId %>"
              class="note-inline"
              type="text"
              inputmode="text"
              maxlength="120"
              placeholder="nota"
              aria-label="Nota per <%= rawName %>"
              oninput="setNote('<%= safeNameJs %>', this.value)"
              style="font-size:12px;background:transparent;color:#7b6d66;border:none;border-bottom:1px dashed #d8c8bf;outline:none;width:10ch"
            /> )
        </span>
      </div>
    <% } %>
  </div>

  <!-- PREZZO + QUANTITÀ -->
  <div class="i-right">
    <div class="i-price">€ <%= priceLabel %></div>

    <div class="i-qty" role="group" aria-label="Quantità per <%= rawName %>">
      <button
        type="button"
        class="q"
        aria-label="Diminuisci <%= rawName %>"
        onclick="dec('<%= safeNameJs %>')">−</button>

      <span
        class="qv"
        id="q-<%= safeId %>"
        aria-live="polite"
        aria-atomic="true">0</span>

      <button
        type="button"
        class="q"
        aria-label="Aumenta <%= rawName %>"
        onclick="inc('<%= safeNameJs %>', <%= priceNum %>)">+</button>
    </div>

    <!-- (RIMOSSO il vecchio campo nota grande) -->
  </div>
</div>

<script>
  // Dizionario base (prima della logica che lo usa)
  const translations = {
    en: {
      "Bruschette": "Bruschetta",
      "Pomodoro, basilico, olio EVO": "Tomato, basil, extra virgin olive oil",
      "Olive & Taralli": "Olives & Taralli",
      "Selezione tipica pugliese": "Typical Apulian selection",
      "Caprese": "Caprese salad",
      "Mozzarella, pomodoro, origano": "Mozzarella, tomato, oregano",
      "Parmigiana": "Eggplant parmigiana",
      "Melanzane, pomodoro, grana": "Eggplant, tomato, parmesan cheese",
      "Fritto misto": "Mixed fried starters",
      "Arancini, crocchè, panelle": "Rice balls, potato croquettes, chickpea fritters"
      // continua con le altre voci se ti servono
    }
  };

  // Traduzione dinamica di nome e descrizione se lingua = 'en'
  (function () {
    const currentLang = localStorage.getItem('lang') || 'it';
    if (currentLang !== 'en') return;

    // Nomi
    document.querySelectorAll('[data-i18n-name]').forEach(el => {
      const key = el.getAttribute('data-i18n-name');
      if (translations.en && translations.en[key]) el.textContent = translations.en[key];
    });

    // Descrizioni: aggiorna SOLO il testo dell'<em> per non perdere la nota inline
    document.querySelectorAll('[data-i18n-desc]').forEach(el => {
      const key = el.getAttribute('data-i18n-desc');
      if (translations.en && translations.en[key]) {
        const em = el.querySelector('em');
        if (em) em.textContent = translations.en[key];
      }
    });
  })();
</script>