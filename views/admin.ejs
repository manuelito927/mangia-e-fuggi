<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mangia & Fuggi ‚Äî Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6efe7;--panel:#fff;--ink:#2c2623;--muted:#7b6d66;
  --brand:#7a4a3b;--ring:#ead8cf;--ok:#1f8f4e;--warn:#b42318
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;font-weight:800;letter-spacing:.3px}
.layout{display:grid;grid-template-columns:230px 1fr;gap:16px}
@media (max-width:900px){.layout{grid-template-columns:1fr}}
.side{
  background:var(--panel);border:1px solid var(--ring);
  border-radius:16px;padding:14px;height:fit-content;
  position:sticky;top:12px
}
.nav .item{
  display:block;padding:10px 12px;border:1px solid #eee;
  border-radius:10px;margin-bottom:8px;color:inherit;text-decoration:none
}
.nav .item.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.card{
  background:var(--panel);border:1px solid var(--ring);
  border-radius:16px;padding:14px;margin-bottom:16px
}
.row{display:flex;gap:10px;justify-content:space-between;align-items:center}
.muted{color:var(--muted)}
.pill{background:#f3e7e2;color:var(--brand);border-radius:999px;padding:6px 10px;font-weight:700}
.pill.ok{background:#e8f6ee;color:var(--ok)}
.pill.warn{background:#fff5dc;color:#a36200}
.pill.takeaway{background:#e0f2fe;color:#075985}
.pill.bad{background:#fdeaea;color:#b42318}
.btn{border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ok{background:#e8f6ee;border-color:#cde8d5;color:var(--ok)}
.btn.danger{background:#fdeaea;border-color:#f3caca;color:var(--warn)}
.btn-ghost{background:#fff;border-color:#ead8cf;color:#7b4a3b}
.input{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;background:#fff}
.order{border:1px solid var(--ring);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
.order .head{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:8px}
.order .rows{margin-top:6px;border-top:1px dashed var(--ring);padding-top:6px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.tbl table{width:100%;border-collapse:collapse;font-size:14px}
.tbl th,.tbl td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.badge{display:inline-flex;align-items:center;gap:6px}
.bell{font-size:18px;cursor:pointer}
.bell.new{color:#d97706}
.clearx{margin-left:6px;cursor:pointer;color:#555}
.kg{display:flex;gap:8px;flex-wrap:wrap}
.kg .k{background:#fff;border:1px solid var(--ring);padding:8px 10px;border-radius:10px}
.tab.active{background:#f1d9d1}
.errorbar{
  background:#fdeaea;border:1px solid #f3caca;color:#7a2e2e;
  border-radius:12px;padding:10px;margin-bottom:12px;display:none
}
</style>
</head>
<body>
<div class="wrap">
  <h1>Mangia & Fuggi ‚Äî Dashboard</h1>
  <div id="err" class="errorbar"></div>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="side">
      <div class="nav">
        <a href="#" class="item active" data-section="orders">üìã Ordini</a>
        <a href="#" class="item" data-section="stats">üìä Statistiche</a>
        <a href="#" class="item" data-section="menu">üçï Menu</a>
        <a href="#" class="item" data-section="tables">ü™ë Tavoli</a>
        <a href="/admin/settings" class="item">‚öôÔ∏è Impostazioni</a>
      </div>
      <div class="card">
        <label style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input type="checkbox" id="chk-sound"/> Suono nuovi ordini
        </label>
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="chk-autorefresh"/> Auto-aggiorna
        </label>
      </div>
    </aside>

    <!-- Main -->
    <main>
      <!-- ORDERS -->
      <section id="sec-orders" class="card">
        <div class="row" style="flex-wrap:wrap">
          <div class="kg">
            <span class="muted">Vista:</span>
            <button class="btn tab active" data-status="all">Tutti <span id="c-all" class="pill" style="padding:2px 8px"></span></button>
            <button class="btn tab" data-status="due">Da incassare <span id="c-due" class="pill" style="padding:2px 8px"></span></button>
            <button class="btn tab" data-status="paid">Accettati <span id="c-paid" class="pill" style="padding:2px 8px"></span></button>
            <button class="btn tab" data-status="canceled">Eliminati <span id="c-canc" class="pill" style="padding:2px 8px"></span></button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="q" class="input" placeholder="Cerca tavolo o piatto‚Ä¶"/>
            <span id="clearQ" class="clearx">Elimina</span>
            <label class="muted" for="dayOrders">Giorno:</label>
            <input id="dayOrders" type="date" class="input"/>
            <button id="btn-refresh" class="btn brand">Aggiorna</button>
          </div>
        </div>
        <div id="orders"></div>
      </section>

      <!-- STATS -->
      <section id="sec-stats" class="card" style="display:none">
        <div class="grid2">
          <div class="card">
            <h3 style="margin:0 0 8px 0">Giorno</h3>
            <div class="row" style="gap:8px">
              <input id="day" type="date" class="input"/>
              <button id="btn-day" class="btn brand">Aggiorna</button>
            </div>
            <div id="kpis" class="kg" style="margin-top:10px">
              <div class="k">Ordini: <b id="k-count">0</b></div>
              <div class="k">Incasso: <b id="k-rev">‚Ç¨ 0,00</b></div>
              <div class="k">Scontrino medio: <b id="k-avg">‚Ç¨ 0,00</b></div>
            </div>
            <div class="card" style="margin-top:12px">
              <canvas id="chartHour" height="160"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 style="margin:0 0 8px 0">Intervallo</h3>
            <div class="row" style="gap:8px">
              <input id="from" type="date" class="input"/>
              <input id="to" type="date" class="input"/>
              <button id="btn-range" class="btn brand">Aggiorna</button>
            </div>
            <div class="card" style="margin-top:12px">
              <canvas id="chartTop" height="160"></canvas>
            </div>
            <div class="tbl" id="topTable" style="margin-top:12px"></div>
          </div>
        </div>
      </section>

      <!-- MENU -->
      <section id="sec-menu" class="card" style="display:none">
        <h3 style="margin-top:0">Menu</h3>
        <p class="muted">
          Qui puoi gestire le voci del men√π (categorie, piatti, prezzi, disponibilit√†).
        </p>

        <h4>Categorie esistenti</h4>
        <ul id="menuCategories" class="muted">
          <li class="muted">Caricamento‚Ä¶</li>
        </ul>

        <!-- Aggiungi categoria -->
        <div style="margin-top:12px">
          <h4 style="margin:0 0 6px 0">Aggiungi categoria</h4>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <input id="newCatName" class="input" placeholder="Nome categoria (es. Pizze)" />
            <input id="newCatSort" class="input" type="number" placeholder="Ordine (es. 1)" style="width:110px" />
            <button id="btnAddCat" class="btn brand">+ Aggiungi</button>
          </div>
          <div id="menuMsg" class="muted" style="margin-top:6px;font-size:13px"></div>
        </div>

       <!-- PRODOTTI -->
<div class="card" style="margin-top:16px">

  <!-- üü§ INIZIO BLOCCO EDITOR CHE SPOSTEREMO -->
  <div id="productEditor">
    <h3 style="margin-top:0">Prodotti</h3>

    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <select id="itemCategory" class="input" style="min-width:160px">
        <option value="">Seleziona categoria</option>
      </select>
      <input id="itemName" class="input" placeholder="Nome prodotto" style="flex:1;min-width:150px" />
    </div>

    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input id="itemDesc" class="input" placeholder="Descrizione (es. Pomodoro, fior di latte, basilico)" style="flex:1;min-width:200px" />
    </div>

    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input
        id="itemImage"
        class="input"
        type="file"
        accept="image/*"
        style="flex:1;min-width:200px"
      />
    </div>

    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input id="itemPrice" class="input" type="number" step="0.01" placeholder="Prezzo ‚Ç¨" style="width:120px" />
      <input id="itemSort" class="input" type="number" placeholder="Ordine" style="width:100px" />
      <label class="muted" style="display:flex;align-items:center;gap:6px">
        <input id="itemAvailable" type="checkbox" checked /> Disponibile
      </label>
      <button id="btnAddItem" class="btn brand">+ Aggiungi prodotto</button>
    </div>

    <div id="itemMsg" class="muted" style="margin-top:6px;font-size:13px"></div>
    <p class="muted" style="font-size:12px;margin-top:10px">
      I prodotti inseriti qui compariranno subito nel men√π pubblico nella categoria scelta.
    </p>
  </div>
  <!-- üü§ FINE BLOCCO EDITOR -->

  <hr style="margin:16px 0 8px">
  <h4>Prodotti esistenti</h4>
  <div id="itemList" class="muted" style="font-size:13px">
    Caricamento...
  </div>
</div>
</div> <!-- chiude la <div class="card" dei Prodotti -->

</section> <!-- chiude la <section id="sec-menu"> -->

<!-- TAVOLI -->
<section id="sec-tables" class="card" style="display:none">
  <h2>Tavoli</h2>
  <p class="muted">Stato dei tavoli in sala.</p>
  <div class="tbl">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Posti</th>
          <th>Stato</th>
          <th>Aggiornato</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="tablesBody"></tbody>
    </table>
  </div>
</section>

</main>
</div>
</div>

<script>
/* ========= UTILS ========= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const euro = n => "‚Ç¨ " + Number(n).toFixed(2).replace(".", ",");

function showErr(msg){
  const bar = $('#err');
  if(!bar) return;
  bar.textContent = msg;
  bar.style.display = 'block';
  setTimeout(()=>{ bar.style.display = 'none'; }, 5000);
}

// fetch con gestione base errori auth
async function F(url, opts = {}){
  opts = opts || {};
  if (!opts.credentials) opts.credentials = 'same-origin';

  const r = await fetch(url, opts);
  if(r.status === 401){
    showErr('Sessione non autenticata. Ricarica la pagina e reinserisci la password.');
  }
  return r;
}

/* ========= NAV LATERALE ========= */
const SECTIONS = {
  orders: $('#sec-orders'),
  stats:  $('#sec-stats'),
  menu:   $('#sec-menu'),
  tables: $('#sec-tables')
};

$$('.nav .item[data-section]').forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    $$('.nav .item').forEach(i=>i.classList.remove('active'));
    link.classList.add('active');
    const target = link.dataset.section;
    Object.entries(SECTIONS).forEach(([key,sec])=>{
      if(!sec) return;
      sec.style.display = (key === target) ? 'block' : 'none';
    });
  });
});

/* ========= MENU: CATEGORIE + PRODOTTI ========= */
let MENU_CATEGORIES = [];
let MENU_ITEMS = [];
let editingItemId = null;

// üîÅ Gestione editor prodotti "mobile"
const productEditor = document.getElementById('productEditor');
let productEditorHomeParent = productEditor ? productEditor.parentElement : null;
let productEditorHomeNextSibling = productEditor ? productEditor.nextElementSibling : null;

// sposta il blocco editor subito sotto la riga passata
function moveEditorBelowRow(rowEl){
  if (!productEditor || !rowEl) return;
  rowEl.insertAdjacentElement('afterend', productEditor);
}

// rimette l'editor al suo posto originale in alto
function resetEditorPosition(){
  if (!productEditor || !productEditorHomeParent) return;
  productEditorHomeParent.insertBefore(productEditor, productEditorHomeNextSibling);
}

async function loadMenu() {
  const ul        = $('#menuCategories');
  const catSelect = $('#itemCategory');

  if (!ul) return;

  ul.innerHTML = '<li class="muted">Caricamento‚Ä¶</li>';
  if (catSelect) {
    catSelect.innerHTML = '<option value="">Seleziona categoria</option>';
  }

  try {
    const res = await fetch('/admin/menu-json', {
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error('bad_response');

    const { ok, categories, items } = await res.json();
    if (!ok) throw new Error('menu_not_ok');

    MENU_CATEGORIES = categories || [];
    MENU_ITEMS      = items || [];

    ul.innerHTML = '';

    if (!MENU_CATEGORIES.length) {
      ul.innerHTML = '<li class="muted">Nessuna categoria ancora creata.</li>';
      if (catSelect) {
        catSelect.innerHTML = '<option value="">Nessuna categoria disponibile</option>';
      }
      renderItemList();
      return;
    }

    // popola select prodotti
    if (catSelect) {
      catSelect.innerHTML = '<option value="">Seleziona categoria</option>';
      MENU_CATEGORIES.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        catSelect.appendChild(opt);
      });
    }

    // lista categorie in alto
    MENU_CATEGORIES.forEach(cat => {
      const catItems   = MENU_ITEMS.filter(it => it.category_id === cat.id);
      const total      = catItems.length;
      const available  = catItems.filter(it => it.is_available).length;

      const li    = document.createElement('li');
      const title = document.createElement('strong');
      title.textContent = cat.name + ' ';

      const count = document.createElement('span');
      count.className   = 'muted';
      count.textContent = `(${available}/${total} disponibili)`;

      const desc  = document.createElement('div');
      desc.className   = 'muted';
      desc.textContent = total
        ? catItems.map(it => `${it.name} (‚Ç¨${Number(it.price).toFixed(2)})`).join(', ')
        : 'Nessun piatto in questa categoria.';

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Elimina';
      delBtn.className   = 'btn btn-ghost';
      delBtn.style.marginLeft = '8px';
      delBtn.onclick = () => deleteCategory(cat.id, cat.name);

      li.appendChild(title);
      li.appendChild(count);
      li.appendChild(delBtn);
      li.appendChild(document.createElement('br'));
      li.appendChild(desc);

      ul.appendChild(li);
    });

    // lista prodotti in basso
    renderItemList();
  } catch (e) {
    console.error('loadMenu error', e);
    ul.innerHTML = '<li class="muted">Errore nel caricamento del men√π.</li>';
    MENU_CATEGORIES = [];
    MENU_ITEMS = [];
    renderItemList();
  }
}

/* AGGIUNGI CATEGORIA */
async function addCategory() {
  const nameInput = $('#newCatName');
  const sortInput = $('#newCatSort');
  const msg       = $('#menuMsg');

  if (!nameInput || !sortInput || !msg) return;

  const name       = (nameInput.value || '').trim();
  const sort_order = Number(sortInput.value || 0) || 0;

  if (!name) {
    msg.textContent = 'Inserisci un nome categoria.';
    return;
  }

  msg.textContent = 'Salvataggio...';

  try {
    const res = await fetch('/admin/menu-json/add-category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, sort_order })
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch (_) {}

    if (!res.ok) {
      console.error('HTTP error:', res.status, text);
      msg.textContent = `Errore HTTP ${res.status}: ${text}`;
      return;
    }

    if (!data || !data.ok) {
      console.error('API error:', data);
      msg.textContent = `Errore API: ${data && data.error ? data.error : 'sconosciuto'}`;
      return;
    }

    msg.textContent = 'Categoria salvata ‚úÖ';
    nameInput.value = '';
    sortInput.value = '';

    await loadMenu();
  } catch (e) {
    console.error('fetch failed', e);
    msg.textContent = 'Errore di rete durante il salvataggio.';
  }
}

/* ELIMINA CATEGORIA */
async function deleteCategory(id, name) {
  const ok = confirm(
    `Eliminare la categoria "${name}"?\n` +
    `Verranno eliminati anche tutti i piatti associati.`
  );
  if (!ok) return;

  try {
    const res = await fetch('/admin/menu-json/delete-category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      console.error('deleteCategory error', res.status, data);
      alert('Errore durante l‚Äôeliminazione della categoria.');
      return;
    }

    await loadMenu();
  } catch (e) {
    console.error(e);
    alert('Errore di rete durante l‚Äôeliminazione.');
  }
}

function renderItemList() {
  const box = $('#itemList');
  if (!box) return;

  if (!MENU_ITEMS.length) {
    box.textContent = 'Nessun prodotto ancora inserito.';
    return;
  }

  box.innerHTML = '';

  MENU_CATEGORIES
    .slice()
    .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
    .forEach(cat => {
      const catItems = MENU_ITEMS.filter(it => it.category_id === cat.id);
      if (!catItems.length) return;

      const block = document.createElement('div');
      block.style.marginBottom = '10px';

      const title = document.createElement('div');
      title.innerHTML = `<strong>${cat.name}</strong>`;
      title.style.marginBottom = '4px';
      block.appendChild(title);

      catItems.forEach(it => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.gap = '6px';
        row.style.borderTop = '1px solid #eee';
        row.style.padding = '4px 0';

        const left = document.createElement('div');
        left.innerHTML = `
          ${it.name}
          <span class="muted">(‚Ç¨ ${Number(it.price).toFixed(2)})</span>
          ${it.is_available === false ? '<span class="muted"> ¬∑ NON disp.</span>' : ''}
        `;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '4px';

        const btnEdit = document.createElement('button');
btnEdit.type = 'button';
btnEdit.className = 'btn btn-ghost';
btnEdit.textContent = '‚úèÔ∏è Modifica';
btnEdit.onclick = () => startEditItem(it.id, row);

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.className = 'btn btn-ghost';
        btnDel.textContent = 'üóë Elimina';
        btnDel.onclick = () => deleteItem(it.id);

        right.appendChild(btnEdit);
        right.appendChild(btnDel);

        row.appendChild(left);
        row.appendChild(right);
        block.appendChild(row);
      });

      box.appendChild(block);
    });

  if (!box.innerHTML.trim()) {
    box.textContent = 'Nessun prodotto ancora inserito.';
  }
}

function startEditItem(id, rowEl) {
  const it = MENU_ITEMS.find(x => x.id === id);
  if (!it) return;

  editingItemId = id;

  $('#itemCategory').value = it.category_id || '';
  $('#itemName').value = it.name || '';
  $('#itemDesc').value = it.description || '';
  $('#itemPrice').value = it.price != null ? String(it.price).replace('.', ',') : '';
  $('#itemSort').value = it.sort_order || '';
  $('#itemAvailable').checked = it.is_available !== false;

  const msg = $('#itemMsg');
  if (msg) {
    msg.textContent = 'Stai modificando questo prodotto. Premi "Salva modifiche".';
  }
  const btn = $('#btnAddItem');
  if (btn) btn.textContent = 'üíæ Salva modifiche';

  // üëá sposta il form sotto la riga che hai cliccato
  if (rowEl) {
    moveEditorBelowRow(rowEl);
    rowEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function resetItemForm() {
  editingItemId = null;
  $('#itemCategory').value = '';
  $('#itemName').value = '';
  $('#itemDesc').value = '';
  $('#itemPrice').value = '';
  $('#itemSort').value = '';
  const img = $('#itemImage');
  if (img) img.value = '';
  $('#itemAvailable').checked = true;
  const msg = $('#itemMsg');
  if (msg) msg.textContent = '';
  const btn = $('#btnAddItem');
  if (btn) btn.textContent = '+ Aggiungi prodotto';

  // üëá rimetti l'editor in alto nella card Prodotti
  resetEditorPosition();
}

async function deleteItem(id) {
  const msg = $('#itemMsg') || $('#menuMsg');
  if (!confirm('Vuoi davvero eliminare questo prodotto?')) return;

  try {
    const res = await fetch('/admin/menu-json/delete-item', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      console.error('deleteItem error', res.status, data);
      if (msg) msg.textContent = 'Errore durante l‚Äôeliminazione del prodotto.';
      return;
    }
    if (editingItemId === id) resetItemForm();
    await loadMenu();
  } catch (e) {
    console.error(e);
    if (msg) msg.textContent = "Errore di rete durante l'eliminazione.";
  }
}

/* AGGIUNGI / MODIFICA PRODOTTO */
async function addItem() {
  const catSelect   = $('#itemCategory');
  const nameInput   = $('#itemName');
  const priceInput  = $('#itemPrice');
  const descInput   = $('#itemDesc');
  const sortInput   = $('#itemSort');
  const imageInput  = $('#itemImage');
  const availCheck  = $('#itemAvailable');
  const msg         = $('#itemMsg') || $('#menuMsg');

  if (!catSelect || !nameInput || !priceInput || !descInput || !msg) return;

  const category_id = Number(catSelect.value || 0);
  const name        = (nameInput.value || '').trim();
  const desc        = (descInput.value || '').trim();
  const price       = Number(String(priceInput.value || '').replace(',', '.'));
  const sort_order  = Number(sortInput.value || 0) || 0;
  const is_available = !!(availCheck && availCheck.checked);
  const file        = imageInput && imageInput.files ? imageInput.files[0] : null;

  if (!category_id) {
    msg.textContent = 'Scegli una categoria per il prodotto.';
    return;
  }
  if (!name) {
    msg.textContent = 'Inserisci il nome del prodotto.';
    return;
  }
  if (!price || price <= 0) {
    msg.textContent = 'Inserisci un prezzo valido.';
    return;
  }

  msg.textContent = editingItemId ? 'Salvataggio modifiche...' : 'Salvataggio prodotto...';

  try {
    const formData = new FormData();
    formData.append('category_id', category_id);
    formData.append('name', name);
    formData.append('description', desc);
    formData.append('price', price);
    formData.append('sort_order', sort_order);
    formData.append('is_available', is_available ? 'true' : 'false');

    if (file) {
      formData.append('image', file);
    }
    if (editingItemId) {
      formData.append('id', editingItemId);
    }

    const url = editingItemId
      ? '/admin/menu-json/update-item'
      : '/admin/menu-json/add-item';

    const res = await fetch(url, {
      method: 'POST',
      body: formData
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch (_) {}

    if (!res.ok) {
      console.error('HTTP error:', res.status, text);
      msg.textContent = `Errore HTTP ${res.status}: ${text}`;
      return;
    }

    if (!data || !data.ok) {
      console.error('API error:', data);
      msg.textContent = `Errore API: ${data && data.error ? data.error : 'sconosciuto'}`;
      return;
    }

    msg.textContent = editingItemId ? 'Modifiche salvate ‚úÖ' : 'Prodotto salvato ‚úÖ';

    resetItemForm();
    await loadMenu();
  } catch (e) {
    console.error('fetch failed', e);
    msg.textContent = 'Errore di rete durante il salvataggio del prodotto.';
  }
}

/* LISTENER MENU */
$('#btnAddCat')?.addEventListener('click', addCategory);
$('#btnAddItem')?.addEventListener('click', addItem);

/* ========= SETTINGS ========= */
async function loadSettings(){
  try{
    const r=await F('/api/settings');
    const j=await r.json();
    if(j.ok){
      $('#chk-sound').checked = !!j.sound_enabled || !!j.sound;
      $('#chk-autorefresh').checked = !!j.autorefresh;
    } else if(j.error === 'auth_required'){
      showErr('Sessione non autenticata. Ricarica la pagina e reinserisci la password.');
    }
  }catch(e){ showErr('Impossibile caricare impostazioni.'); }
}
async function saveSettings(){
  try{
    const payload = {
      sound_enabled: $('#chk-sound').checked,
      autorefresh: $('#chk-autorefresh').checked
    };
    await F('/api/settings',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    setAutoRefresh();
  }catch(e){ showErr('Salvataggio impostazioni fallito.'); }
}
$('#chk-sound').addEventListener('change', saveSettings);
$('#chk-autorefresh').addEventListener('change', saveSettings);

/* ========= DATE/FORMATO ORARIO ========= */
function isoLocalDateStr(dOrIso){
  const d = (dOrIso instanceof Date) ? dOrIso : new Date(dOrIso);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
const ROME_TZ = 'Europe/Rome';
function formatRome(iso){
  return new Date(iso).toLocaleString('it-IT', { timeZone: ROME_TZ });
}

/* ========= ORDINI ========= */
let STATUS='all', ORDERS=[], SUBS=false, refreshTimer=null;
let TABLES_MAP = {};

async function counters(){
  try{
    const daySel = $('#dayOrders').value || isoLocalDateStr(new Date());
    const [pnd, cmp, cnc] = await Promise.all([
      F(`/api/orders?status=pending&day=${daySel}`).then(r=>r.json()),
      F(`/api/orders?status=completed&day=${daySel}`).then(r=>r.json()),
      F(`/api/orders?status=canceled&day=${daySel}`).then(r=>r.json())
    ]);
    const pend = (pnd.ok ? (pnd.orders||[]) : []);
    const comp = (cmp.ok ? (cmp.orders||[]) : []);
    const canc = (cnc.ok ? (cnc.orders||[]) : []);

    const nAll = pend.filter(o=>!o.ack).length + comp.length;
    const nDue = pend.filter(o=> o.ack).length;

    $('#c-all').textContent  = nAll;
    $('#c-due').textContent  = nDue;
    $('#c-paid').textContent = comp.length;
    $('#c-canc').textContent = canc.length;
  }catch(e){ /* soft */ }
}

async function fetchOrders(){
  try{
    // ‚úÖ prendiamo lo stato tavoli dalla stessa API usata dai clienti
    const t = await F('/api/tables/status').then(r => r.json());
    if (t.ok) {
      TABLES_MAP = {};
      (t.tables || []).forEach(tb => {
        TABLES_MAP[(tb.name || ('Tavolo ' + tb.id))] = tb.status;
        TABLES_MAP[tb.id] = tb.status;
      });
    }

    const q = $('#q').value.toLowerCase();
    const daySel = $('#dayOrders').value || isoLocalDateStr(new Date());

    let list = [];
    const [pnd, cmp, cnc] = await Promise.all([
      F(`/api/orders?status=pending&day=${daySel}`).then(r=>r.json()),
      F(`/api/orders?status=completed&day=${daySel}`).then(r=>r.json()),
      F(`/api/orders?status=canceled&day=${daySel}`).then(r=>r.json())
    ]);
    const pend = (pnd.ok ? (pnd.orders||[]) : []);
    const comp = (cmp.ok ? (cmp.orders||[]) : []);
    const canc = (cnc.ok ? (cnc.orders||[]) : []);

    if(STATUS==='all'){ list = pend.filter(o=>!o.ack).concat(comp); }
    else if(STATUS==='due'){ list = pend.filter(o=>o.ack); }
    else if(STATUS==='paid'){ list = comp; }
    else if(STATUS==='canceled'){ list = canc; }

    list.sort((a,b)=> (b.created_at||'').localeCompare(a.created_at||''));
    ORDERS=list;
    renderOrders(q);
    counters();
  }catch(e){
    showErr('Errore nel caricamento ordini. Se richiesto, reinserisci la password della dashboard.');
  }
}

function badgeForDue(order){
  if(order.status==='completed') return '<span class="pill ok">pagato</span>';
  const key = order.table_code || ('Tavolo ?');
  const st  = TABLES_MAP[key];
  if(st==='occupied') return '<span class="pill warn">in attesa</span>';
  return '<span class="pill bad">non pagato</span>';
}

function renderOrders(q){
  const root=$('#orders'); root.innerHTML="";
  const filtered = q ? ORDERS.filter(o=>{
    const text=(o.table_code||"-")+" "+(o.items||[]).map(i=>i.name).join(" ");
    return text.toLowerCase().includes(q);
  }) : ORDERS;

  if(!filtered.length){ root.innerHTML='<div class="muted">Nessun ordine</div>'; return; }

  for(const o of filtered){
    const when = formatRome(o.created_at);
    const rows=(o.items||[]).map(it=>`
      <div class="row" style="padding:4px 0">
        <div>${it.qty}√ó ${it.name} <span class="muted">(‚Ç¨ ${Number(it.price).toFixed(2)})</span></div>
        <div><b>‚Ç¨ ${(Number(it.qty)*Number(it.price)).toFixed(2)}</b></div>
      </div>`).join("");

    const bell = (!o.ack && o.status==='pending')
      ? `<span class="bell new" data-act="ack" data-id="${o.id}" title="Nuovo">üîî</span>`
      : `<span class="bell" data-act="ack" data-id="${o.id}" title="Segna come letto">üîï</span>`;

    let actions = '';
    if(STATUS==='all'){
      if(o.status==='pending' && !o.ack){
        actions = `
          <button class="btn" data-act="print" data-id="${o.id}">üñ®Ô∏è Stampa</button>
          <button class="btn danger" data-act="cancel" data-id="${o.id}">üóëÔ∏è Elimina</button>
          <button class="btn ok" data-act="mark_due" data-id="${o.id}">‚úÖ Fatto</button>`;
      }else{
        actions = `<button class="btn" data-act="print" data-id="${o.id}">üñ®Ô∏è Stampa</button>`;
      }
    }else if(STATUS==='due'){
      const badge = badgeForDue(o);
      actions = `
        ${badge}
        <button class="btn brand" data-act="receipt" data-id="${o.id}">üßæ Scontrino</button>
        <button class="btn ok" data-act="complete" data-id="${o.id}">üí∂ Pagato in cassa</button>
        <button class="btn danger" data-act="cancel" data-id="${o.id}">üóëÔ∏è Elimina</button>`;
    }else if(STATUS==='paid'){
      actions = `<button class="btn" data-act="print" data-id="${o.id}">üñ®Ô∏è Stampa</button>`;
    }else if(STATUS==='canceled'){
      actions = `<button class="btn" data-act="restore" data-id="${o.id}">‚Ü©Ô∏è Ripristina</button>`;
    }

    const el=document.createElement('div');
    el.className='order';
    el.innerHTML=`
      <div class="head">
        <div>
          <div class="muted">ID: ${o.id}</div>
          <div class="muted">Tavolo: <b>${o.table_code||'-'}</b></div>
          <div class="muted">Data: ${when}</div>
        </div>
        <div class="badge">${bell}<span class="pill">Totale: ${euro(o.total)}</span></div>
      </div>
      <div class="rows">${rows}</div>
      <div class="row" style="margin-top:8px">
        <div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">${actions}</div>
      </div>`;
    root.appendChild(el);
  }
}

$('#orders').addEventListener('click', async ev=>{
  const b=ev.target.closest('[data-act]');
  if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  try{
    if(act==='print'){ window.print(); await F(`/api/orders/${id}/printed`,{method:'POST'}); return; }
    if(act==='complete'){ await F(`/api/orders/${id}/complete`,{method:'POST'}); }
    if(act==='cancel'){ if(!confirm('Confermi eliminazione?')) return; await F(`/api/orders/${id}/cancel`,{method:'POST'}); }
    if(act==='restore'){ await F(`/api/orders/${id}/restore`,{method:'POST'}); }
    if(act==='receipt'){ await emitReceipt(id); return; }
    if(act==='ack'){ await F(`/api/orders/${id}/ack`,{method:'POST'}); }
    if(act==='mark_due'){
      await F(`/api/orders/${id}/ack`,{method:'POST'});
      STATUS='due';
      $$('.tab').forEach(x=>x.classList.remove('active'));
      $$('[data-status="due"]')[0]?.classList.add('active');
    }
  }catch(e){ showErr('Azione fallita: verifica la sessione.'); }
  await fetchOrders();
});

async function emitReceipt(orderId){
  try{
    const r = await F('/api/fiscal/receipt', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ orderId })
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'errore');
    alert('‚úÖ Scontrino creato (MOCK). Con SIGN-IT sar√† fiscale al 100%.');
  }catch(e){
    console.error(e);
    showErr('Errore nella creazione dello scontrino.');
  }
}

/* ========= TABS / RICERCA ========= */
$$('.tab').forEach(t=>{
  t.addEventListener('click', async ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    STATUS=t.dataset.status;
    await fetchOrders();
  });
});
$('#btn-refresh').addEventListener('click', fetchOrders);
$('#q').addEventListener('input', ()=>renderOrders($('#q').value.toLowerCase()));
$('#clearQ').addEventListener('click', ()=>{ $('#q').value=''; renderOrders(''); });
document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='dayOrders') fetchOrders(); });

/* ========= AUTO-REFRESH ========= */
function setAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  if($('#chk-autorefresh').checked){
    refreshTimer = setInterval(fetchOrders, 8000);
  }
}

/* ========= REALTIME ========= */
function attachRealtime(){
  if(typeof supabase === 'undefined' || typeof supabase.channel!=="function" || SUBS) return;
  SUBS=true;
  supabase.channel("rt:orders")
    .on("postgres_changes",{event:"*",schema:"public",table:"orders"},async()=>{
      if($('#chk-sound').checked) beep();
      await fetchOrders();
    }).subscribe();

  supabase.channel("rt:order_items")
    .on("postgres_changes",{event:"*",schema:"public",table:"order_items"},async()=>{
      await fetchOrders();
    }).subscribe();
}
function attachRealtimeTables(){
  if(typeof supabase === 'undefined' || typeof supabase.channel!=="function") return;
  supabase.channel("rt:restaurant_tables")
    .on("postgres_changes",{event:"*",schema:"public",table:"restaurant_tables"},async()=>{
      await loadTables();
      await fetchOrders();
    }).subscribe();
}
function beep(){
  try{
    const c=new (window.AudioContext||window.webkitAudioContext)();
    const o=c.createOscillator(),g=c.createGain();
    o.frequency.value=900;o.type="triangle";
    o.connect(g);g.connect(c.destination);
    g.gain.setValueAtTime(.001,c.currentTime);
    g.gain.exponentialRampToValueAtTime(.2,c.currentTime+.01);
    o.start();o.stop(c.currentTime+.14);
  }catch{}
}

/* ========= STATISTICHE ========= */
let chartHour=null, chartTop=null;
function setKPI(cnt,rev){
  $('#k-count').textContent=cnt;
  $('#k-rev').textContent=euro(rev);
  $('#k-avg').textContent=euro(cnt?rev/cnt:0);
}

async function loadDay(){
  try{
    const d=$('#day').value || new Date().toISOString().slice(0,10);
    const r=await F(`/api/stats/day?date=${d}`);
    const j=await r.json();
    if(!j.ok) return;
    setKPI(j.count, j.total);
    const labels=j.perBucket.rows.map(b=>new Date(b.bucket).getHours());
    const data=j.perBucket.rows.map(b=>b.revenue);
    if(chartHour) chartHour.destroy();
    chartHour=new Chart($('#chartHour'),{
      type:'bar',
      data:{labels,datasets:[{label:'Incasso ‚Ç¨/ora',data}]},
      options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Ç¨ '+v}}}}
    });
  }catch(e){ showErr('Errore caricamento statistiche giorno.'); }
}

async function loadRange(){
  try{
    const f=$('#from').value,t=$('#to').value;
    if(!f||!t) return;
    const r=await F(`/api/stats/range?from=${f}&to=${t}`);
    const j=await r.json();
    if(!j.ok) return;
    const top=j.top.list.slice(0,5);
    const labels=top.map(x=>x.name), data=top.map(x=>x.qty);
    if(chartTop) chartTop.destroy();
    chartTop=new Chart($('#chartTop'),{
      type:'doughnut',
      data:{labels,datasets:[{data}]},
      options:{plugins:{legend:{position:'bottom'}}}
    });
    $('#topTable').innerHTML=`<table><thead><tr><th>Prodotto</th><th>Qt√†</th><th>Fatturato</th><th>% Qt√†</th><th>% Fatt.</th></tr></thead><tbody>${
      j.top.list.map(x=>`<tr><td>${x.name}</td><td>${x.qty}</td><td>${euro(x.revenue)}</td><td>${x.pctQty.toFixed(1)}%</td><td>${x.pctRev.toFixed(1)}%</td></tr>`).join('')
    }</tbody></table>`;
  }catch(e){ showErr('Errore caricamento statistiche intervallo.'); }
}

/* ========= TAVOLI ========= */
async function loadTables(){
  try{
    // ‚úÖ stessa API della pagina di prenotazione clienti
    const r = await F('/api/tables/status');
    const j = await r.json();
    if (!j.ok) return;

    const tbody = $('#tablesBody');
    tbody.innerHTML = '';

    if (!j.tables || !j.tables.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" class="muted">Nessun tavolo configurato.</td>';
      tbody.appendChild(tr);
      TABLES_MAP = {};
      return;
    }

    TABLES_MAP = {};
    j.tables.forEach(t => {
      TABLES_MAP[(t.name || ('Tavolo ' + t.id))] = t.status;
      TABLES_MAP[t.id] = t.status;

      const stateText =
        t.status === 'reserved'
          ? 'üü° Prenotato'
          : (t.status === 'occupied' ? 'üî¥ Occupato' : 'üü¢ Libero');

const tr = document.createElement('tr');
tr.innerHTML = `
  <td>${t.name || 'Tavolo ' + t.id}</td>
  <td>${t.seats ?? '-'}</td>
  <td>${stateText}</td>
  <td>-</td>
  <td>
    <button
      class="btn ok"
      data-table-id="${t.id}"
      data-table-action="free"
    >Libera</button>
    <button
      class="btn danger"
      data-table-id="${t.id}"
      data-table-action="seat"
    >Siede</button>
  </td>`;
tbody.appendChild(tr);

    });
  }catch(e){
    showErr('Errore caricamento tavoli.');
  }
}

async function setTable(id, action) {
  try {
    console.log("setTable chiamato con", id, action);

    const res = await F(`/api/tables/${id}/${action}`, {
      method: "POST"
    });

    // proviamo a leggere la risposta come testo per vedere eventuali errori
    const text = await res.text();
    console.log("Risposta API tavolo:", res.status, text);

    if (!res.ok) {
      // qui vediamo immediatamente se √® 403, 500, ecc.
      showErr(`Errore tavolo: HTTP ${res.status} - ${text}`);
      alert(`Errore tavolo: HTTP ${res.status}\n\n${text}`);
      return;
    }

    // se ok, ricarichiamo
    await loadTables();
    await fetchOrders();
  } catch (e) {
    console.error("setTable exception", e);
    showErr("Aggiornamento tavolo fallito (JS).");
    alert("Errore JS setTable: " + (e.message || e));
  }
}

// ‚úÖ Click su "Libera" / "Siede" nella tabella tavoli
$('#tablesBody').addEventListener('click', (ev) => {
  const btn = ev.target.closest('[data-table-action]');
  if (!btn) return;

  const id = btn.getAttribute('data-table-id');
  const action = btn.getAttribute('data-table-action');

  setTable(id, action);
});

/* ========= BOOT ========= */
(async()=>{
  const today=new Date();
  $('#day').value=isoLocalDateStr(today);
  const from=new Date(); from.setDate(today.getDate()-6);
  $('#from').value=isoLocalDateStr(from);
  $('#to').value=isoLocalDateStr(today);
  $('#dayOrders').value = isoLocalDateStr(today);

  await loadSettings();
  await fetchOrders();
  await loadDay();
  await loadRange();
  await loadMenu();
  await loadTables();
  attachRealtime();
  attachRealtimeTables();
  setAutoRefresh();
})();

$('#btn-day').addEventListener('click',loadDay);
$('#btn-range').addEventListener('click',loadRange);
</script>
</body>
</html>