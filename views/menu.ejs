<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mangia & Fuggi â€“ Menu</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#f6efe9; margin:0; padding:20px;}
    header{max-width:1100px;margin:0 auto 20px;display:flex;justify-content:space-between;align-items:center}
    .title{font-weight:700;font-size:28px;color:#7b4b3a}
    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:#fff;border-radius:14px;padding:16px 18px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    h2{font-size:20px;margin:8px 0 12px;color:#7b4b3a}
    .item{display:grid;grid-template-columns:1fr auto 120px;gap:8px;align-items:center;padding:10px 0;border-bottom:1px dashed #e7d6c9}
    .name{font-weight:600}
    .desc{font-style:italic;color:#6b6b6b;font-size:14px}
    .price{font-weight:600;white-space:nowrap}
    .qty{display:flex;align-items:center;justify-content:flex-end;gap:10px}
    .btn{border:0;border-radius:22px;padding:6px 12px;background:#7b4b3a;color:#fff;cursor:pointer}
    .btn.small{padding:4px 10px;border-radius:16px}
    .btn.alt{background:#2f855a}
    .btn.ghost{background:#eee;color:#333}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .cart h3{margin:0 0 10px}
    .cart ul{list-style:none;padding:0;margin:0;max-height:50vh;overflow:auto}
    .cart li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
    .cart .tot{display:flex;justify-content:space-between;font-weight:700;margin-top:8px}
    .note{font-size:12px;color:#666;margin-top:6px;line-height:1.4}
    @media (max-width:900px){.container{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="title">Mangia &amp; Fuggi</div>
  </header>

  <div class="container">
    <main>
      <!-- ANTIPASTI -->
      <section class="card">
        <h2>Antipasti</h2>
        <%- include('partials/item', {name:'Bruschette', desc:'Pomodoro, basilico, olio EVO', price:4.00}) %>
        <%- include('partials/item', {name:'Olive & Taralli', desc:'Selezione tipica pugliese', price:3.50}) %>
        <%- include('partials/item', {name:'Caprese', desc:'Mozzarella, pomodoro, origano', price:7.00}) %>
        <%- include('partials/item', {name:'Parmigiana', desc:'Melanzane, pomodoro, grana', price:7.50}) %>
        <%- include('partials/item', {name:'Fritto misto', desc:'Arancini, crocchÃ¨, panelle', price:8.00}) %>
      </section>

      <!-- PIZZE CLASSICHE -->
      <section class="card">
        <h2>Pizze classiche</h2>
        <%- include('partials/item', {name:'Margherita', desc:'Pomodoro, mozzarella, basilico', price:5.00}) %>
        <%- include('partials/item', {name:'Marinara', desc:'Pomodoro, aglio, origano', price:4.50}) %>
        <%- include('partials/item', {name:'Diavola', desc:'Salame piccante', price:7.00}) %>
        <%- include('partials/item', {name:'Prosciutto e funghi', desc:'Cotto e champignon', price:7.50}) %>
        <%- include('partials/item', {name:'Quattro formaggi', desc:'Mozzarella, gorgonzola, grana, provola', price:8.00}) %>
      </section>

      <!-- PIZZE GOURMET -->
      <section class="card">
        <h2>Pizze gourmet</h2>
        <%- include('partials/item', {name:'Bufalina', desc:'Pomodoro, bufala DOP, basilico', price:9.00}) %>
        <%- include('partials/item', {name:'Tartufo', desc:'Crema di tartufo, provola, speck', price:11.00}) %>
        <%- include('partials/item', {name:'Mortazza', desc:'Pistacchio, stracciatella, mortadella', price:10.50}) %>
        <%- include('partials/item', {name:'Nduja & Burrata', desc:'â€™Nduja calabrese, burrata', price:10.00}) %>
      </section>

      <!-- BEVANDE -->
      <section class="card">
        <h2>Bevande</h2>
        <%- include('partials/item', {name:'Acqua', desc:'Naturale o frizzante', price:1.50}) %>
        <%- include('partials/item', {name:'Coca-Cola', desc:'Lattina 33cl', price:2.50}) %>
        <%- include('partials/item', {name:'Birra', desc:'Chiara alla spina', price:4.00}) %>
        <%- include('partials/item', {name:'Vino della casa', desc:'Bicchiere', price:3.50}) %>
      </section>

      <!-- DESSERT -->
      <section class="card">
        <h2>Dessert</h2>
        <%- include('partials/item', {name:'TiramisÃ¹', desc:'Classico', price:4.50}) %>
        <%- include('partials/item', {name:'Panna cotta', desc:'Frutti di bosco', price:4.00}) %>
        <%- include('partials/item', {name:'Cheesecake', desc:'Ricotta e pistacchio', price:4.50}) %>
      </section>
    </main>

    <aside class="card cart">
      <h3>Carrello</h3>
      <ul id="cart"></ul>
      <div class="tot"><span>Totale</span><span id="total">â‚¬ 0,00</span></div>

      <!-- Azioni -->
      <button class="btn" style="width:100%;margin-top:10px" onclick="checkout()">Conferma ordine</button>
      <button id="btn-pay" class="btn alt" style="width:100%;margin-top:10px" onclick="payOnline()" disabled>
        ðŸ’³ Paga Online
      </button>
      <div class="note">
        Il pagamento si apre su SumUp con lâ€™importo reale del carrello.
      </div>
    </aside>
  </div>

  <script>
    const cart = new Map();

    function cssId(s){ return s.replace(/[^a-z0-9]+/gi,'_'); }
    function euro(n){ return "â‚¬ "+Number(n).toFixed(2).replace(".",","); }

    function inc(name, price){
      const it = cart.get(name)||{price,qty:0};
      it.qty++; cart.set(name,it);
      document.getElementById('q-'+cssId(name)).textContent=it.qty;
      renderCart();
    }
    function dec(name){
      const it = cart.get(name)||{qty:0,price:0};
      it.qty=Math.max(0,it.qty-1);
      if(it.qty===0) cart.delete(name); else cart.set(name,it);
      document.getElementById('q-'+cssId(name)).textContent=it.qty||0;
      renderCart();
    }

    function renderCart(){
      const ul=document.getElementById('cart'); ul.innerHTML="";
      let tot=0;
      for(const [n,it] of cart.entries()){
        tot+=it.qty*it.price;
        const li=document.createElement('li');
        li.innerHTML=`<span>${it.qty} Ã— ${n}</span><span>${euro(it.qty*it.price)}</span>`;
        ul.appendChild(li);
      }
      document.getElementById('total').textContent=euro(tot);
      document.getElementById('btn-pay').disabled = tot <= 0;
    }

    async function checkout(){
      const items=Array.from(cart.entries()).map(([n,it])=>({name:n,price:it.price,qty:it.qty}));
      if(items.length===0){ alert("Aggiungi almeno un prodotto"); return; }
      const tableCode=null;
      const total=items.reduce((s,i)=>s+i.price*i.qty,0);
      const r=await fetch("/api/checkout",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({tableCode,items,total})
      });
      const js=await r.json();
      if(js.ok){
        alert("Ordine inviato!");
        // NON svuoto il carrello: cosÃ¬ lâ€™utente puÃ² pagare subito dopo
        // cart.clear(); renderCart(); document.querySelectorAll("[id^='q-']").forEach(e=>e.textContent="0");
      } else {
        alert("Errore invio ordine: "+(js.error||"impossibile inviare"));
      }
    }

    async function payOnline(){
      const items=Array.from(cart.entries()).map(([n,it])=>({name:n,price:it.price,qty:it.qty}));
      if(items.length===0){ alert("Carrello vuoto"); return; }
      const total=items.reduce((s,i)=>s+i.price*i.qty,0);
      // descrizione breve (max 128 tipicamente)
      const desc = "Mangia & Fuggi - Ordine tavolo";
      // genera link di pagamento dinamico sul server
      const r = await fetch("/api/pay-sumup", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          amount: Number(total.toFixed(2)),
          currency: "EUR",
          description: desc
        })
      });
      const js = await r.json();
      if(js.ok && js.url){
        window.open(js.url, "_blank");
      } else {
        alert("Pagamento non disponibile. Verifica configurazione SumUp.");
      }
    }
  </script>
</body>
</html>