<!doctype html>
<html lang="it" data-lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Mangia & Fuggi ‚Äì Menu</title>

  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* ==== Fix iPhone zoom e tap ==== */
    html, body {
      text-size-adjust: 100%;
      -webkit-text-size-adjust: 100%;
    }
    * { touch-action: manipulation; }
    .btn, .lang-select, input, select { font-size: 16px; } /* evita zoom sui form iOS */

    /* ==== Stili generali ==== */
/* === Stile nomi piatti + descrizione === */
.item-name{
  font-weight:700;      /* nome in grassetto */
  margin-bottom:2px;
}

.item-desc{
  margin-bottom:4px;    /* piccolo spazio sotto gli ingredienti */
  white-space:normal;   /* niente elenco verticale */
}

.item-desc em{
  font-style:italic;    /* corsivo per gli ingredienti */
  font-size:14px;
  color:#6b5a54;        /* marroncino leggibile */
  display:inline;       /* testo in linea */
  white-space:normal;   /* ignora gli a capo dentro il testo */
}

.item-main{
  display:flex;
  gap:8px;
  align-items:flex-start;
}

.item-photo img{
  width:60px;
  height:60px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid #e6e2df;
}

/* opzionale, leggermente pi√π piccola su schermi piccoli */
@media (max-width:480px){
  .item-photo img{
    width:54px;
    height:54px;
  }
}

    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:#fff;border-radius:14px;padding:16px 18px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    h2{font-size:20px;margin:8px 0 12px;color:#7b4b3a}
    .note{font-size:12px;color:#666;margin-top:6px;line-height:1.4}
    .warn{color:#b42318}
    header{max-width:1100px;margin:0 auto 20px;display:flex;gap:12px;align-items:center}
    header img.logo{width:46px;height:46px;object-fit:cover;border-radius:8px;border:2px solid #7b4b3a22}
    .title{font-weight:700;font-size:28px;color:#7b4b3a}
    .header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
    .lang-select{padding:6px 10px;border:1px solid #e6e2df;border-radius:8px;background:#fafafa;cursor:pointer}
    .btn-row{display:flex;flex-direction:column;gap:10px}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    @media (max-width:900px){.container{grid-template-columns:1fr}}

    /* ‚Äî‚Äî Modal semplice per "Dividi & paga" ‚Äî‚Äî */
    .modal-backdrop{
      position:fixed; inset:0; background:#0008; display:none;
      align-items:center; justify-content:center; z-index:50;
    }
    .modal{
      width:min(680px, 94vw); background:#fff; border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.35); overflow:hidden;
    }
    .modal header{padding:14px 16px; border-bottom:1px solid #eee; margin:0; max-width:none}
    .modal .body{padding:16px}
.close-x{
  margin-left:auto;
  font-size:24px;
  line-height:1;
  cursor:pointer;
  width:40px;
  height:40px;
  border:none;
  background:transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  -webkit-tap-highlight-color: transparent; /* iPhone: niente lampeggio blu */
}

    .tabs{display:flex; gap:8px; margin-bottom:12px}
    .tab{border:1px solid #e6e2df; background:#faf9f7; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600}
    .tab.active{background:#7b4b3a; color:#fff; border-color:#7b4b3a}

    .row{display:flex; gap:8px; align-items:center; margin:6px 0}
    .row input[type="text"]{flex:1; padding:8px 10px; border:1px solid #e6e2df; border-radius:8px}
    .row input[type="number"]{width:130px; padding:8px 10px; border:1px solid #e6e2df; border-radius:8px}
    .pill{background:#f3f1ef; padding:6px 10px; border-radius:999px; font-weight:700}
    .split-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .muted{color:#777; font-size:13px}
    .err{color:#b42318; font-size:13px}

    .quota-list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
    .quota-item{display:flex; gap:10px; align-items:center; justify-content:space-between;
      border:1px dashed #e6e2df; padding:10px; border-radius:10px}
<style>
  /* ‚Äî‚Äî Layout quote pi√π ordinato ‚Äî‚Äî */
  .quota-item{ align-items:flex-start; }                  /* allinea in alto a sx */
  .quota-left{ display:flex; flex-direction:column; gap:2px; }
  .quota-title{ font-weight:700; }
  .small{ font-size:12px; color:#777; }

  .amount{ margin-top:2px; }
  .amount-line{ display:flex; align-items:baseline; gap:6px; }
  .amount-line .euro{
    background:#f3f1ef; padding:2px 6px; border-radius:8px; font-weight:700;
  }
  .amount-line .val{
    font-weight:800; font-size:18px; line-height:1;
  }

  .quota-actions{ display:flex; gap:8px; flex-wrap:wrap; }

/* ---- Modalit√† ordine: Al tavolo / Da casa ---- */
.order-mode{
  display:flex;
  gap:8px;
  margin:6px 0 4px;
}

.mode-btn{
  flex:1;
  border-radius:999px;
  border:1px solid #e6e2df;
  background:#faf3ef;
  padding:6px 10px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
}

.mode-btn.active{
  background:#7b4b3a;
  color:#fff;
  border-color:#7b4b3a;
}

.home-fields{
  margin:4px 0 8px;
}
.home-fields .input{
  font-size:14px;
}

</style>
  </style>
</head>
<body>
  <header>
    <img class="logo" src="/img/LOGO.JPG" alt="Logo" onerror="this.src='/img/fallback.jpg'">
    <div class="title">Mangia &amp; Fuggi</div>
    <div class="header-right">
      <label for="lang" class="muted" data-i18n="label_language">Lingua</label>
      <select id="lang" class="lang-select" aria-label="Language">
        <option value="it">Italiano</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="card">
        <h2>Men√π</h2>
        <p class="muted">
          Seleziona i prodotti e aggiungili al carrello.
        </p>

        <div id="menu-app">
          <p class="muted">Caricamento men√π‚Ä¶</p>
        </div>
      </section>
    </main>

    <aside class="card cart">
  <h3 data-i18n="cart_title">Carrello</h3>

  <!-- üîÄ Modalit√† ordine -->
  <div class="order-mode">
    <button type="button"
            class="mode-btn active"
            data-mode="table">
      Al tavolo
    </button>
    <button type="button"
            class="mode-btn"
            data-mode="home">
      Da casa
    </button>
  </div>

  <p id="mode-help" class="note">
    Stai ordinando <b>al tavolo</b>. Il personale porter√† l‚Äôordine dove sei seduto.
  </p>

  <!-- üè† Campi visibili solo in modalit√† "Da casa" -->
  <div id="home-fields" class="home-fields" style="display:none">
    <input id="homeName" class="input"
           style="width:100%;margin-bottom:6px"
           placeholder="Nome e cognome" />
    <input id="homePhone" class="input"
           style="width:100%;margin-bottom:6px"
           placeholder="Telefono" />
    <textarea id="homeNote" class="input" rows="2"
              style="width:100%;margin-bottom:6px"
              placeholder="Nota (es. ritiro alle 21:00, senza consegna a domicilio)"></textarea>
  </div>

  <ul id="cart"></ul>
  <div class="tot">
    <span data-i18n="cart_total">Totale</span>
    <span id="total">‚Ç¨ 0,00</span>
  </div>

  <div class="btn-row" style="margin-top:10px">
    <button id="btn-pay-online" class="btn" disabled data-i18n="btn_pay_online">
      üí≥ Ordina &amp; paga online
    </button>
    <button id="btn-pay-cashier" class="btn btn-ghost" disabled data-i18n="btn_pay_counter">
      üíµ Ordina &amp; paga in cassa
    </button>
    <button id="btn-split" class="btn btn-ghost" disabled data-i18n="btn_split_pay">
      ‚ûó Dividi &amp; paga
    </button>
  </div>

  <div id="pay-note" class="note"></div>
</aside>

  <!-- ===== Modal DIVIDI & PAGA ===== -->
  <div id="split-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <div class="title" style="font-size:20px;color:#7b4b3a;margin:0" data-i18n="split_title">Dividi &amp; paga</div>
<button
  type="button"
  class="close-x"
  aria-label="Chiudi"
  onclick="closeSplitModal()"
>
  √ó
</button>
      </header>
      <div class="body">
        <div class="muted" data-i18n="bill_total_prefix">Totale conto:</div>
        <span id="split-total" class="pill" style="margin-left:6px">‚Ç¨ 0,00</span>

        <div class="tabs" style="margin-top:8px">
          <button id="tab-equal" class="tab active" onclick="setSplitMode('equal')" data-i18n="tab_equal">Alla romana</button>
          <button id="tab-custom" class="tab" onclick="setSplitMode('custom')" data-i18n="tab_custom">Importi personalizzati</button>
        </div>

        <!-- Alla romana -->
        <div id="pane-equal">
          <div class="row">
            <label for="equal-n" data-i18n="label_people">Numero persone:</label>
            <input id="equal-n" type="number" min="2" value="2" oninput="renderEqual()" />
            <span class="muted" data-i18n="hint_auto_share">Quota per persona calcolata automaticamente.</span>
          </div>
          <div id="equal-quotas" class="quota-list"></div>
        </div>

        <!-- Personalizzato -->
        <div id="pane-custom" style="display:none">
          <div id="custom-rows"></div>
          <div class="split-actions">
            <button class="btn btn-ghost" type="button" onclick="addCustomRow()" data-i18n="btn_add_person">+ Aggiungi persona</button>
            <span class="muted" data-i18n="hint_sum_equal">La somma deve essere uguale al totale.</span>
          </div>
          <div id="custom-error" class="err" style="display:none"></div>
          <div id="custom-quotas" class="quota-list" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ====== Mini i18n (IT predefinito, EN opzionale) ====== */
    const I18N = {
      it: {
        label_language: "Lingua",
        sec_starters: "Antipasti",
        sec_classic: "Pizze classiche",
        sec_gourmet: "Pizze gourmet",
        sec_drinks: "Bevande",
        sec_desserts: "Dessert",
        cart_title: "Carrello",
        cart_total: "Totale",
        btn_pay_online: "üí≥ Ordina & paga online",
        btn_pay_counter: "üíµ Ordina & paga in cassa",
        btn_split_pay: "‚ûó Dividi & paga",
        split_title: "Dividi & paga",
        bill_total_prefix: "Totale conto:",
        tab_equal: "Alla romana",
        tab_custom: "Importi personalizzati",
        label_people: "Numero persone:",
        hint_auto_share: "Quota per persona calcolata automaticamente.",
        btn_add_person: "+ Aggiungi persona",
        hint_sum_equal: "La somma deve essere uguale al totale.",
        person_n: i => `Persona ${i}`,
        person_generic: "Persona",
        pay_share_n: i => `Paga quota #${i}`,
        /* ‚ñº‚ñº‚ñº NUOVE ETICHETTE ‚ñº‚ñº‚ñº */
        pay_share_online_n: i => `Paga quota #${i} online`,
        pay_share_counter_n: i => `Paga in cassa #${i}`,
        /* ‚ñ≤‚ñ≤‚ñ≤ NUOVE ETICHETTE ‚ñ≤‚ñ≤‚ñ≤ */
        placeholder_name: "Nome (opzionale)",
        placeholder_amount: "Importo es. 7.50",
        alert_add_item: "Aggiungi almeno un prodotto",
        err_send_order: "Errore invio ordine",
        pay_enabled_note: "Il pagamento online aprir√† SumUp con l‚Äôimporto del carrello.",
        pay_disabled_note: "Pagamento online disabilitato: verifica credenziali SumUp.",
        pay_not_available: "Pagamento online non disponibile.",
        order_sent_counter: "Ordine inviato! Presentati in cassa per il pagamento.",
        sum_must_equal: (sum, tot) => `La somma degli importi (${sum}) deve essere uguale al totale (${tot}).`
      },
      en: {
        label_language: "Language",
        sec_starters: "Starters",
        sec_classic: "Classic pizzas",
        sec_gourmet: "Gourmet pizzas",
        sec_drinks: "Drinks",
        sec_desserts: "Desserts",
        cart_title: "Cart",
        cart_total: "Total",
        btn_pay_online: "üí≥ Order & pay online",
        btn_pay_counter: "üíµ Order & pay at counter",
        btn_split_pay: "‚ûó Split & pay",
        split_title: "Split & pay",
        bill_total_prefix: "Bill total:",
        tab_equal: "Split evenly",
        tab_custom: "Custom amounts",
        label_people: "Number of people:",
        hint_auto_share: "Per-person share calculated automatically.",
        btn_add_person: "+ Add person",
        hint_sum_equal: "The sum must equal the total.",
        person_n: i => `Person ${i}`,
        person_generic: "Person",
        pay_share_n: i => `Pay share #${i}`,
        /* ‚ñº‚ñº‚ñº NEW LABELS ‚ñº‚ñº‚ñº */
        pay_share_online_n: i => `Pay share #${i} online`,
        pay_share_counter_n: i => `Pay at counter #${i}`,
        /* ‚ñ≤‚ñ≤‚ñ≤ NEW LABELS ‚ñ≤‚ñ≤‚ñ≤ */
        placeholder_name: "Name (optional)",
        placeholder_amount: "Amount e.g. 7.50",
        alert_add_item: "Add at least one item",
        err_send_order: "Error sending order",
        pay_enabled_note: "Online payment will open SumUp with the cart amount.",
        pay_disabled_note: "Online payment disabled: check SumUp credentials.",
        pay_not_available: "Online payment not available.",
        order_sent_counter: "Order sent! Please pay at the counter.",
        sum_must_equal: (sum, tot) => `The sum of amounts (${sum}) must equal the total (${tot}).`
      }
    };

    // Dizionario prodotti/ingredienti (IT -> EN) senza toccare gli include
    const ITEM_I18N = {
      // ‚Äî Antipasti
      "Bruschette":"Bruschetta",
      "Pomodoro, basilico, olio EVO":"Tomato, basil, extra-virgin olive oil",
      "Olive & Taralli":"Olives & Taralli",
      "Selezione tipica pugliese":"Typical Apulian selection",
      "Caprese":"Caprese",
      "Mozzarella, pomodoro, origano":"Mozzarella, tomato, oregano",
      "Parmigiana":"Eggplant Parmigiana",
      "Melanzane, pomodoro, grana":"Eggplant, tomato, Grana cheese",
      "Fritto misto":"Mixed fried starters",
      "Arancini, crocch√®, panelle":"Rice balls, potato croquettes, chickpea fritters",

      // ‚Äî Pizze classiche
      "Margherita":"Margherita",
      "Pomodoro, mozzarella, basilico":"Tomato, mozzarella, basil",
      "Marinara":"Marinara",
      "Pomodoro, aglio, origano":"Tomato, garlic, oregano",
      "Diavola":"Diavola",
      "Salame piccante":"Spicy salami",
      "Prosciutto e funghi":"Ham & mushrooms",
      "Cotto e champignon":"Cooked ham and mushrooms",
      "Quattro formaggi":"Four cheeses",
      "Mozzarella, gorgonzola, grana, provola":"Mozzarella, gorgonzola, Grana, provola",

      // ‚Äî Pizze gourmet
      "Pizze gourmet":"Gourmet pizzas",
      "Bufalina":"Bufalina",
      "Pomodoro, bufala DOP, basilico":"Tomato, buffalo mozzarella PDO, basil",
      "Tartufo":"Truffle",
      "Crema di tartufo, provola, speck":"Truffle cream, provola, speck",
      "Mortazza":"Mortazza",
      "Pistacchio, stracciatella, mortadella":"Pistachio, stracciatella, mortadella",
      "Nduja & Burrata":"‚ÄôNduja & Burrata",
      "‚ÄôNduja calabrese, burrata":"Calabrian ‚Äônduja, burrata",

      // ‚Äî Bevande
      "Bevande":"Drinks",
      "Acqua":"Water",
      "Naturale o frizzante":"Still or sparkling",
      "Coca-Cola":"Coca-Cola",
      "Lattina 33cl":"33cl can",
      "Birra":"Beer",
      "Chiara alla spina":"Light draft",
      "Vino della casa":"House wine",
      "Bicchiere":"Glass",

      // ‚Äî Dessert
      "Dessert":"Desserts",
      "Tiramis√π":"Tiramisu",
      "Classico":"Classic",
      "Panna cotta":"Panna cotta",
      "Frutti di bosco":"Mixed berries",
      "Cheesecake":"Cheesecake",
      "Ricotta e pistacchio":"Ricotta & pistachio"
    };

    function getLang(){
      return localStorage.getItem("lang") || document.documentElement.dataset.lang || "it";
    }
    function setLang(lang){
      const newLang = (lang==="en") ? "en" : "it";
      localStorage.setItem("lang", newLang);
      document.documentElement.lang = newLang;
      document.documentElement.dataset.lang = newLang;
      applyI18n();
    }
    function t(key){
      const lang = getLang();
      return I18N[lang][key] ?? I18N.it[key] ?? key;
    }

    function translateItems(){
      const lang = getLang();

      // Nomi: prendiamo SEMPRE la chiave IT da data-i18n-name
      document.querySelectorAll('[data-i18n-name]').forEach(el=>{
        const key = el.getAttribute('data-i18n-name');
        el.textContent = (lang === 'en') ? (ITEM_I18N[key] || key) : key;
      });

      // Descrizioni: aggiorniamo SOLO l'<em> con data-i18n-desc
      // (non tocchiamo il contenitore .i-desc, cos√¨ l'input note resta cliccabile)
      document.querySelectorAll('em[data-i18n-desc]').forEach(em=>{
        const key = em.getAttribute('data-i18n-desc');
        em.textContent = (lang === 'en') ? (ITEM_I18N[key] || key) : key;
      });
    }

    function applyI18n(){
      // elementi con data-i18n (testo semplice)
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        const val = t(k);
        if(typeof val === "string") el.textContent = val;
      });
      translateItems(); // <‚Äî traduce nomi e descrizioni prodotti senza toccare il markup
      // placeholder input nel pannello custom
      document.querySelectorAll('#custom-rows input[type="text"]').forEach(i=>i.placeholder = t("placeholder_name"));
      document.querySelectorAll('#custom-rows input[type="number"]').forEach(i=>i.placeholder = t("placeholder_amount"));
      // nota pagamento
      renderPayNote();
      // ri-render pannelli split per aggiornare testi dinamici
      if (document.getElementById('split-backdrop').style.display === 'flex'){
        (splitMode==='equal') ? renderEqual() : renderCustom();
      }
    }

    // imposta selettore lingua
    (function initLang(){
      const sel = document.getElementById("lang");
      sel.value = getLang();
      sel.addEventListener("change", e=>setLang(e.target.value));
      applyI18n();
    })();
  </script>

  <script>
    // ======= Stato carrello / pagamenti (CON NOTE) =======
    const cart = new Map();         // mappa: name -> { price, qty, note? }
    let PAY_ENABLED = false;
// 'table' = in locale; 'home' = ordini da casa
let ORDER_MODE = 'table';
    (async () => {
      try{
        const r = await fetch("/api/pay-config");
        const j = await r.json();
        PAY_ENABLED = !!(j && j.enabled);
      }catch{}
      renderPayNote();
      updateButtons();
    })();

    function renderPayNote(){
      const el = document.getElementById("pay-note");
      if(!el) return;
      el.innerHTML = PAY_ENABLED
        ? t("pay_enabled_note")
        : `<span class="warn">${t("pay_disabled_note")}</span>`;
    }

function updateOrderModeUI(){
  const help    = document.getElementById('mode-help');
  const homeBox = document.getElementById('home-fields');
  const btns    = document.querySelectorAll('.mode-btn');

  btns.forEach(b=>{
    b.classList.toggle('active', b.dataset.mode === ORDER_MODE);
  });

  if(help){
    if(ORDER_MODE === 'table'){
      help.innerHTML = 'Stai ordinando <b>al tavolo</b>. Il personale porter√† l‚Äôordine dove sei seduto.';
    }else{
      help.innerHTML = 'Stai ordinando <b>da casa</b>. Indica i tuoi dati per il ritiro/pagamento.';
    }
  }

  if(homeBox){
    homeBox.style.display = (ORDER_MODE === 'home') ? 'block' : 'none';
  }

  // opzionale: nascondi "Dividi & paga" se da casa non ti serve
  const btnSplit = document.getElementById('btn-split');
  if(btnSplit){
    btnSplit.style.display = (ORDER_MODE === 'home') ? 'none' : 'block';
  }
}

function setOrderMode(mode){
  ORDER_MODE = (mode === 'home') ? 'home' : 'table';
  updateOrderModeUI();
}

    // Utils
    function cssId(s){
      return String(s).toLowerCase().replace(/[^a-z0-9]+/gi,'_');
    }
    function euro(n){
      return "‚Ç¨ " + Number(n).toFixed(2).replace(".", ",");
    }
    function cartTotal(){
      return Array.from(cart.values()).reduce((s, i) => s + i.qty * i.price, 0);
    }

    // Sanitize nota utente (no HTML, max 120 char)
    function cleanNote(v){
      return String(v || "")
        .replace(/[<>]/g, "")        // niente tag
        .replace(/\s+/g, " ")        // spazi multipli -> 1 spazio
        .trim()
        .slice(0, 120);
    }

    // Salva/aggiorna la nota per un prodotto
    function setNote(name, value){
      const key = String(name);
      const it = cart.get(key) || { price: 0, qty: 0, note: "" };
      it.note = cleanNote(value);
      cart.set(key, it);
      renderCart();
    }

    // === PATCH VISUAL Q.T√Ä (mostra sempre il numerino accanto ai bottoni) ===
    function updateInlineQtyDisplay(btnEl, qty){
      if(!btnEl) return;
      let span = btnEl.previousElementSibling;
      if(!(span instanceof HTMLElement) || span.tagName!=="SPAN"){
        span = btnEl.nextElementSibling;
      }
      if(!(span instanceof HTMLElement) || span.tagName!=="SPAN"){
        span = btnEl.parentElement?.querySelector('.qty, .q, [data-qty]');
      }
      if(span) span.textContent = qty;
    }

    // Q.t√† (aggiornate per gestire anche il prezzo su item gi√† esistenti con nota)
    function inc(name, price){
      const key = String(name);
      const it = cart.get(key) || { price, qty: 0, note: "" };
      it.qty++;
      if(!it.price && price) it.price = Number(price) || 0;
      cart.set(key, it);

      const qEl = document.getElementById('q-'+cssId(name));
      if(qEl) qEl.textContent = it.qty;

      const btn = window.event?.target?.closest('button');
      updateInlineQtyDisplay(btn, it.qty);

      renderCart();
    }

    function dec(name){
      const key = String(name);
      const it = cart.get(key) || { qty: 0, price: 0, note: "" };
      it.qty = Math.max(0, it.qty - 1);
      if(it.qty === 0) cart.delete(key); else cart.set(key, it);

      const qEl = document.getElementById('q-'+cssId(name));
      if(qEl) qEl.textContent = it.qty || 0;

      const btn = window.event?.target?.closest('button');
      updateInlineQtyDisplay(btn, it.qty || 0);

      renderCart();
    }

// üîó Collega i bottoni modalit√† ordine
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    setOrderMode(btn.dataset.mode);
  });
});

// Mantieni la UI coerente al caricamento
updateOrderModeUI();

// Render carrello (mostra la nota e aggiunge il bottone ‚ùå)
function renderCart(){
  const ul = document.getElementById('cart');
  if (!ul) return;

  ul.innerHTML = "";
  let tot = 0;

  for (const [n, it] of cart.entries()) {
    if (!it.qty) continue;

    const lineTotal = it.qty * it.price;
    tot += lineTotal;

    const li = document.createElement('li');
    li.className = "cart-row";
    li.style.display = "flex";
    li.style.alignItems = "flex-start";
    li.style.justifyContent = "space-between";
    li.style.gap = "8px";

    // ---- parte sinistra: nome + eventuale nota
    const leftBox = document.createElement('div');

    const title = document.createElement('strong');
    title.textContent = `${it.qty} √ó ${n}`;
    leftBox.appendChild(title);

    if (it.note) {
      const noteDiv = document.createElement('div');
      noteDiv.className = "muted";
      noteDiv.style.fontSize = "12px";
      noteDiv.style.marginTop = "2px";
      noteDiv.innerHTML = `‚Ä¢ Nota: <em>${it.note}</em>`;
      leftBox.appendChild(noteDiv);
    }

    // ---- parte destra: prezzo + bottone ‚ùå
    const rightBox = document.createElement('div');
    rightBox.style.display = "flex";
    rightBox.style.alignItems = "center";
    rightBox.style.gap = "6px";

    const priceEl = document.createElement('div');
    priceEl.textContent = euro(lineTotal);

    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "btn btn-ghost";
    btn.textContent = "‚úï";
btn.addEventListener('click', () => dec(n));

    rightBox.appendChild(priceEl);
    rightBox.appendChild(btn);

    li.appendChild(leftBox);
    li.appendChild(rightBox);

    ul.appendChild(li);
  }

  const totEl = document.getElementById('total');
  if (totEl) totEl.textContent = euro(tot);

  updateButtons();
}

    // ‚Äî‚Äî RESET delle quantit√† nel menu + pulizia note
    function resetMenuQuantities(){
      document.querySelectorAll('.i-qty .qv').forEach(s => { s.textContent = '0'; });
      document.querySelectorAll('.note-inline').forEach(i => { i.value = ''; });
    }

    function updateButtons(){
      const hasItems = cart.size > 0 && cartTotal() > 0;
      const btnCash = document.getElementById('btn-pay-cashier');
      const btnOnline = document.getElementById('btn-pay-online');
      const btnSplit = document.getElementById('btn-split');
      if(btnCash) btnCash.disabled = !hasItems;
      if(btnOnline) btnOnline.disabled = !(hasItems && PAY_ENABLED);
      if(btnSplit) btnSplit.disabled = !(hasItems && PAY_ENABLED);
    }

let CREATING_ORDER = false;

// ‚Äî‚Äî Core: salva ordine e ritorna { order_id, total }
async function createOrder(){
  if (CREATING_ORDER) {
    // gi√† in corso, evito doppio ordine
    return null;
  }
  CREATING_ORDER = true;

  const items = Array.from(cart.entries())
    .filter(([_, it]) => it.qty > 0)
    .map(([n, it]) => ({
      name: it.note ? `${n} ‚Äî Note: ${it.note}` : n,
      price: it.price,
      qty: it.qty
    }));

  if (!items.length) {
    alert(t("alert_add_item"));
    CREATING_ORDER = false;
    return null;
  }

  const total = cartTotal();

  // üîπ base payload comune
  const payload = { items, total };

  const params = new URLSearchParams(window.location.search);
  const tableCode =
    params.get("t") ||
    params.get("table") ||
    params.get("tableCode") ||
    params.get("tavolo") ||
    null;

  if (ORDER_MODE === "table") {
    payload.tableCode = tableCode;
    payload.orderMode = "table";
  } else {
    const nameEl  = document.getElementById("homeName");
    const phoneEl = document.getElementById("homePhone");
    const noteEl  = document.getElementById("homeNote");

    const customerName  = (nameEl?.value || "").trim();
    const customerPhone = (phoneEl?.value || "").trim();
    const customerNote  = (noteEl?.value || "").trim();

    if (!customerName || !customerPhone) {
      alert("Per gli ordini da casa inserisci almeno nome e telefono.");
      CREATING_ORDER = false;
      return null;
    }

    payload.orderMode     = "home";
    payload.customerName  = customerName;
    payload.customerPhone = customerPhone;
    payload.customerNote  = customerNote;
  }

  try {
    const res = await fetch("/api/checkout", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok || !data.ok) {
      console.error("checkout error", data);
      alert(t("err_send_order"));
      CREATING_ORDER = false;
      return null;
    }

    return {
          return { order_id: data.order_id, total };
    };
  } catch (e) {
    console.error("createOrder failed", e);
    alert(t("err_send_order"));
    return null;
  } finally {
    CREATING_ORDER = false;
  }
}

   // üí≥ Ordina & paga online (intero)
async function orderAndPayOnline(){
  if(!PAY_ENABLED){ alert(t("pay_not_available")); return; }
  const saved = await createOrder();
  if(!saved) return;

  const ok = await payAmount(saved.total, `Mangia & Fuggi - Ordine #${saved.order_id}`);
  if(ok){
    cart.clear();
    renderCart();
    resetMenuQuantities(); // azzera menu e note
  }
}

// üíµ Ordina & paga in cassa (intero)
async function orderPayAtCounter(){
  const saved = await createOrder();
  if(!saved) return;
  alert(t("order_sent_counter"));
  cart.clear();
  renderCart();
  resetMenuQuantities(); // azzera menu e note
}

// üîó Aggancio sicuro dei bottoni (anche se gli onclick inline vengono bloccati)
document.addEventListener("DOMContentLoaded", () => {
  // Bottoni principali nel carrello
  const btnOnline  = document.getElementById("btn-pay-online");
  const btnCashier = document.getElementById("btn-pay-cashier");
  const btnSplit   = document.getElementById("btn-split");

  if (btnOnline)  btnOnline.addEventListener("click",  orderAndPayOnline);
  if (btnCashier) btnCashier.addEventListener("click", orderPayAtCounter);
  if (btnSplit)   btnSplit.addEventListener("click",   openSplitModal);

  // ‚ùå X in alto nel popup
  const btnClose = document.querySelector(".close-x");
  if (btnClose) btnClose.addEventListener("click", closeSplitModal);

  // Tab "Alla romana" / "Importi personalizzati"
  const tabEqual  = document.getElementById("tab-equal");
  const tabCustom = document.getElementById("tab-custom");

  if (tabEqual)
    tabEqual.addEventListener("click", () => setSplitMode('equal'));

  if (tabCustom)
    tabCustom.addEventListener("click", () => setSplitMode('custom'));

  // üîÄ Modalit√† ordine: Al tavolo / Da casa
  document.querySelectorAll('.mode-btn').forEach(btn=>{
    btn.addEventListener('click', () => {
      setOrderMode(btn.dataset.mode);
    });
  });

  // Stato grafico iniziale (di default "al tavolo")
  updateOrderModeUI();
});

    // ======= DIVIDI & PAGA =======
// ======= DIVIDI & PAGA =======
let splitMode = 'equal'; // 'equal' | 'custom'

// apre il popup
function openSplitModal(){
  const totalEl  = document.getElementById('split-total');
  const backdrop = document.getElementById('split-backdrop');

  if (totalEl)  totalEl.textContent = euro(cartTotal());
  if (backdrop) backdrop.style.display = 'flex';

  // ogni volta che apro parto da "Alla romana"
  splitMode = 'equal';
  resetCustom();        // prepara le righe per il custom
  setSplitMode('equal'); // imposta tab attiva e renderEqual()
  applyI18n();          // aggiorna i testi in base alla lingua
}

// chiude il popup (usato dalla X)
function closeSplitModal(){
  const el = document.getElementById('split-backdrop');
  if (el) el.style.display = 'none';
}

function setSplitMode(mode){
  splitMode = mode;
  document.getElementById('tab-equal').classList.toggle('active', mode==='equal');
  document.getElementById('tab-custom').classList.toggle('active', mode==='custom');
  document.getElementById('pane-equal').style.display = (mode==='equal')?'block':'none';
  document.getElementById('pane-custom').style.display = (mode==='custom')?'block':'none';
  (mode==='equal') ? renderEqual() : renderCustom();
}

    // Alla romana
    // Alla romana
function renderEqual(){
  const n   = Math.max(2, Number(document.getElementById('equal-n').value || 2));
  const tot = cartTotal();
  const quota = Math.round((tot/n)*100)/100;
  const list = document.getElementById('equal-quotas');
  list.innerHTML = "";

  const amountStr = euro(quota).replace('‚Ç¨ ','').trim();

  for(let i=1;i<=n;i++){
    const div = document.createElement('div');
    div.className = "quota-item";
    div.innerHTML = `
      <div class="quota-left">
        <div class="quota-title">${t("person_n")(i)}</div>
        <div class="amount">
          <div class="small">${t("cart_total")}</div>
          <div class="amount-line">
            <span class="euro">‚Ç¨</span>
            <span class="val">${amountStr}</span>
          </div>
        </div>
      </div>
      <div class="quota-actions">
        <button class="btn" type="button" ${!PAY_ENABLED?'disabled':''}
          data-pay-quota-online="${quota.toFixed(2)}">${t("pay_share_online_n")(i)}</button>
        <button class="btn btn-ghost" type="button"
          data-pay-quota-counter="${quota.toFixed(2)}">${t("pay_share_counter_n")(i)}</button>
      </div>
    `;
    list.appendChild(div);
  }
}

    // Personalizzato
    function resetCustom(){
      document.getElementById('custom-rows').innerHTML = "";
      document.getElementById('custom-quotas').innerHTML = "";
      document.getElementById('custom-error').style.display = "none";
      for(let i=1;i<=2;i++) addCustomRow();
      document.querySelectorAll('#custom-rows input[type="text"]').forEach(i=>i.placeholder = t("placeholder_name"));
      document.querySelectorAll('#custom-rows input[type="number"]').forEach(i=>i.placeholder = t("placeholder_amount"));
    }
    function addCustomRow(){
      const wrap = document.getElementById('custom-rows');
      const idx = wrap.children.length+1;
      const row = document.createElement('div');
      row.className="row";
      row.innerHTML = `
        <input type="text" placeholder="${t("placeholder_name")}" value="${t("person_n")(idx)}">
        <input type="number" step="0.01" min="0" placeholder="${t("placeholder_amount")}" oninput="renderCustom()">
      `;
      wrap.appendChild(row);
      renderCustom();
    }
function renderCustom(){
  const rows = [...document.querySelectorAll('#custom-rows .row')];
  const quotas = [];

  for(const r of rows){
    const name = r.querySelector('input[type="text"]').value.trim() || t('person_generic');
    const val  = Number(r.querySelector('input[type="number"]').value || 0);
    if(val>0) quotas.push({name, amount: Math.round(val*100)/100});
  }

  const sum = quotas.reduce((s,q)=>s+q.amount,0);
  const tot = Math.round(cartTotal()*100)/100;

  const err = document.getElementById('custom-error');
  if(sum !== tot){
    err.style.display = "block";
    err.textContent = t("sum_must_equal")(euro(sum), euro(tot));
  } else {
    err.style.display = "none";
  }

  const list = document.getElementById('custom-quotas');
  list.innerHTML="";

  quotas.forEach((q, i)=>{
    const amountStr = euro(q.amount).replace('‚Ç¨ ','').trim();
    const div = document.createElement('div');
    div.className = "quota-item";
    div.innerHTML = `
      <div class="quota-left">
        <div class="quota-title"><strong>${q.name}</strong></div>
        <div class="amount">
          <div class="small">${t("cart_total")}</div>
          <div class="amount-line">
            <span class="euro">‚Ç¨</span>
            <span class="val">${amountStr}</span>
          </div>
        </div>
      </div>
      <div class="quota-actions">
        <button class="btn" type="button" ${(sum!==tot || !PAY_ENABLED)?'disabled':''}
          data-pay-quota-online="${q.amount.toFixed(2)}">${t("pay_share_online_n")(i+1)}</button>
        <button class="btn btn-ghost" type="button" ${sum!==tot?'disabled':''}
          data-pay-quota-counter="${q.amount.toFixed(2)}">${t("pay_share_counter_n")(i+1)}</button>
      </div>
    `;
    list.appendChild(div);
  });
}

    // ‚Äî Esegue un pagamento SumUp per un importo specifico (quota)
    async function payQuota(amount){
      if(!PAY_ENABLED){ alert(t("pay_not_available")); return; }
      const saved = await createOrder(); // un ordine backend; quota pagata separatamente
      if(!saved) return;
      await payAmount(Number(amount), `Mangia & Fuggi - Quota ordine #${saved.order_id}`);
    }

// üéØ Gestione click sui bottoni di quota (anche su iPhone)
document.addEventListener("click", (ev) => {
  const onlineBtn = ev.target.closest("[data-pay-quota-online]");
  if (onlineBtn) {
    const amount = Number(onlineBtn.getAttribute("data-pay-quota-online") || "0");
    if (amount > 0) payQuota(amount);
    return;
  }

  const counterBtn = ev.target.closest("[data-pay-quota-counter]");
  if (counterBtn) {
    const amount = Number(counterBtn.getAttribute("data-pay-quota-counter") || "0");
    if (amount > 0) payQuotaAtCounter(amount);
  }
});

    // ‚Äî Quota pagata in cassa (nessun redirect, non svuota carrello)
    async function payQuotaAtCounter(amount){
      const saved = await createOrder(); // crea l'ordine con riepilogo
      if(!saved) return;
      alert(t("order_sent_counter")); // messaggio standard
      // NON svuotiamo il carrello: altri devono ancora pagare
    }

    // ‚Äî Chiamata generica a /api/pay-sumup (con diagnostica e redirect diretto)
    async function payAmount(amount, description){
      try{
        const r = await fetch("/api/pay-sumup", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            amount: Number(amount.toFixed(2)),
            currency:"EUR",
            description
          })
        });

        const text = await r.text();
        let js; try { js = JSON.parse(text); } catch { js = { ok:false, raw:text }; }

        if (r.ok && js.ok && js.url){
          location.href = js.url; // redirect diretto
          return true;
        }

        const msg = js?.error || js?.data?.message || js?.raw || `HTTP ${r.status}`;
        alert(t("pay_not_available") + "\nDettagli: " + msg);
        console.error("pay-sumup error:", {status:r.status, js});
        return false;
      }catch(err){
        alert(t("pay_not_available") + "\nNetwork error.");
        console.error(err);
        return false;
      }
    }
  </script>

<script>
  async function loadPublicMenu() {
    const root = document.getElementById('menu-app');
    if (!root) return;

    root.innerHTML = '<p class="muted">Caricamento men√π‚Ä¶</p>';

    try {
      const res = await fetch('/api/menu');
      if (!res.ok) throw new Error('bad_response');
      const { ok, categories, items } = await res.json();
      if (!ok) throw new Error('menu_not_ok');

      if (!categories || !categories.length) {
        root.innerHTML = '<p class="muted">Men√π non ancora configurato.</p>';
        return;
      }

      // Ordina le categorie per sort_order (vuote in fondo) e poi per id
      categories.sort((a, b) => {
        const sa = (a.sort_order == null ? 9999 : a.sort_order);
        const sb = (b.sort_order == null ? 9999 : b.sort_order);
        if (sa !== sb) return sa - sb;
        return (a.id || 0) - (b.id || 0);
      });

      const cats = [...categories]
        .filter(c => c.is_active !== false)
        .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

      root.innerHTML = '';

      cats.forEach(cat => {
        const section = document.createElement('section');
        section.className = 'card';
        section.style.marginBottom = '12px';

        const h2 = document.createElement('h2');
        h2.textContent = cat.name;
        section.appendChild(h2);

        const catItems = (items || []).filter(
          it => it.category_id === cat.id && (it.is_available !== false)
        );

        if (!catItems.length) {
          const p = document.createElement('p');
          p.className = 'muted';
          p.textContent = 'Nessun prodotto disponibile in questa categoria.';
          section.appendChild(p);
          root.appendChild(section);
          return;
        }

        // ------- RIGHE PRODOTTI (con immagine opzionale) -------
        catItems.forEach(it => {
          const row = document.createElement('div');
          row.className = 'menu-row';
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.gap = '10px';
          row.style.alignItems = 'flex-start';
          row.style.padding = '8px 0';
          row.style.borderTop = '1px solid #eee';

          // SINISTRA: immagine (se c'√®) + testo
          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.gap = '10px';
          left.style.alignItems = 'flex-start';

          // immagine prodotto
          if (it.image_url) {
            const imgBox = document.createElement('div');
            imgBox.style.flexShrink = '0';

            const img = document.createElement('img');
            img.src = it.image_url;
            img.alt = it.name;
            img.loading = 'lazy';
            img.style.width = '72px';
            img.style.height = '72px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '10px';
            img.style.border = '1px solid #eee';
            img.onerror = function () {
              this.style.display = 'none';
            };

            imgBox.appendChild(img);
            left.appendChild(imgBox);
          }

          // testo (nome + descrizione)
          const textBox = document.createElement('div');
          textBox.style.flex = '1';

          const nameEl = document.createElement('div');
          nameEl.className = 'item-name';
          nameEl.textContent = it.name;
          nameEl.setAttribute('data-i18n-name', it.name);
          textBox.appendChild(nameEl);

          if (it.description) {
            const descWrap = document.createElement('div');
            descWrap.className = 'item-desc';

            const em = document.createElement('em');
            const flatDesc = String(it.description).replace(/\s*\n\s*/g, ', ');
            em.textContent = flatDesc;
            em.setAttribute('data-i18n-desc', it.description);

            descWrap.appendChild(em);
            textBox.appendChild(descWrap);
          }

          left.appendChild(textBox);

          // DESTRA: pulsanti quantit√† + nota
          const qtyBox = document.createElement('div');
          qtyBox.className = 'i-qty';
          qtyBox.style.display = 'flex';
          qtyBox.style.flexDirection = 'column';
          qtyBox.style.alignItems = 'flex-end';
          qtyBox.style.gap = '4px';

          const controls = document.createElement('div');
          controls.style.display = 'flex';
          controls.style.alignItems = 'center';
          controls.style.gap = '6px';

          const btnMinus = document.createElement('button');
          btnMinus.type = 'button';
          btnMinus.className = 'btn btn-ghost';
          btnMinus.textContent = '‚àí';
          btnMinus.addEventListener('click', () => dec(it.name));

          const qtySpan = document.createElement('span');
          qtySpan.className = 'qv';
          const idSafe = cssId(it.name);
          qtySpan.id = 'q-' + idSafe;
          qtySpan.textContent = '0';

          const btnPlus = document.createElement('button');
          btnPlus.type = 'button';
          btnPlus.className = 'btn';
          btnPlus.textContent = '+';
          btnPlus.addEventListener('click', () => inc(it.name, it.price));

          controls.appendChild(btnMinus);
          controls.appendChild(qtySpan);
          controls.appendChild(btnPlus);

          const noteInput = document.createElement('input');
          noteInput.className = 'note-inline';
          noteInput.placeholder = 'Nota (es. senza cipolla)';
          noteInput.addEventListener('input', () => setNote(it.name, noteInput.value));

          qtyBox.appendChild(controls);
          qtyBox.appendChild(noteInput);

          row.appendChild(left);
          row.appendChild(qtyBox);
          section.appendChild(row);
        });

        root.appendChild(section);
      });

      if (typeof applyI18n === 'function') {
        applyI18n();
      }
    } catch (e) {
      console.error(e);
      root.innerHTML = '<p class="muted">Errore nel caricamento del men√π.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadPublicMenu);
</script>

</body>
</html>